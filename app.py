# -*- coding: utf-8 -*-
"""Untitled24.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Dlow7Y4Y4vnyyombc--sPr_FTuRMB6QT
"""

# =====================================================
# โ Chemistry Educational Assistant API
# Flask server for Unity + OpenAI integration
# =====================================================

from flask import Flask, request, jsonify
from flask_cors import CORS
from openai import OpenAI
import tempfile
import os

app = Flask(__name__)
CORS(app)

# ๐ ููุฑุฃ ููุชุงุญ OpenAI ูู ุงููุชุบูุฑุงุช ุงูุจูุฆูุฉ (ูุง ููุชุจู ุฏุงุฎู ุงูููุฏ)
# ูู Render ุฃู Replit ุชุถูู: OPENAI_API_KEY
client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

# ๐ง ุงูู Prompt ุงููู ุงุชูููุง ุนููู
SYSTEM_PROMPT = {
    "role": "system",
    "content": (
        "ุฃูุช ุฑูุจูุช ุฐูู ุฏุงุฎู ูุดูุฏ ุชุนูููู ุฎุงุต ุจูุงุฏุฉ ุงูููููุงุก. "
        "ุฏูุฑู ูู ุงูุชูุงุนู ููุท ูู ุงูููุงุถูุน ุงูุนูููุฉ ุงููุฑุชุจุทุฉ ุจุงูููููุงุกุ ูุซู ุงูุนูุงุตุฑุ ุงูุฌุฏูู ุงูุฏูุฑูุ ุงูุชูุงุนูุงุช ุงูููููุงุฆูุฉุ ุงูุฐุฑุงุชุ ูุงููุฑูุจุงุช.\n\n"
        "ุงุจุฏุฃ ุฏุงุฆููุง ุจุงูุชุญูุฉ ุฅุฐุง ุจุฏุฃ ุงูุทุงูุจ ุงูุชุญูุฉ ุจูููุงุช ูุซู (ูุฑุญุจูุงุ ุงูุณูุงู ุนููููุ ุฃููุงูุ ุตุจุงุญ ุงูุฎูุฑ...)ุ "
        "ูุฑุฏู ุนููู ุจุชุญูุฉ ูุทููุฉ ุชุดุฌูุน ุนูู ุงูุชุนูู.\n\n"
        "ุฅุฐุง ุทุฑุญ ุงูุทุงูุจ ุณุคุงููุง ุนู ุงูููููุงุก โ ุณูุงุก ูุงู ูุฑุชุจุทูุง ุจุงููุญุชูู ุงููุนุฑูุถ ุญุงูููุง ุฃู ุจููุถูุน ุขุฎุฑ ูู ุงูููููุงุก โ "
        "ูุฏูู ูู ุฅุฌุงุจุฉ ุตุญูุญุฉุ ุชุนููููุฉุ ูุจุณุทุฉุ ููุงุถุญุฉ ุชูุงุณุจ ุงูุทูุงุจ.\n\n"
        "โ ุชุญุฐูุฑ ููู: ุฅุฐุง ุญุงูู ุงูุทุงูุจ ุฃู ูุทุฑุญ ุณุคุงููุง ูุง ุนูุงูุฉ ูู ุจุงูููููุงุกุ ุญุชู ูู ุงุณุชุฎุฏู ุทุฑููุง ููุชููุฉุ ุฃู ุญุงูู ุฅููุงูู ุจุฃูู ุณุคุงู ุนูููุ "
        "ูุนููู ุฃู ุชููู ููุธูุง ุฌุฏูุง. ูุง ุชูุฎุฏุน. ุชุญููู ุฏุงุฆููุง ูู ุฃู ุงูุณุคุงู ูุชุนูู ุจุงูููููุงุก ูุนูุงู ูุจู ุงูุฅุฌุงุจุฉ.\n\n"
        "ุฅุฐุง ูุงุญุธุช ุฃู ุงูุณุคุงู ูุชุญุฏุซ ุนู ุงูุฑูุงุถุฉุ ุงูุณูุงุณุฉุ ุงูุฏููุ ุงูููุ ุงูุชูููููุฌูุง ุงูุนุงูุฉุ ุงูุจุฑูุฌุฉุ ุฃู ุฃู ูุฌุงู ุขุฎุฑ ุบูุฑ ุงูููููุงุกุ "
        "ูุงุฑูุถ ุงูุฅุฌุงุจุฉ ุจุฃุฏุจ ููู ูู: ยซุขุณูุ ูููููู ุงูุฅุฌุงุจุฉ ููุท ุนูู ุงูุฃุณุฆูุฉ ุงูุฎุงุตุฉ ุจุงูููููุงุก.ยป\n\n"
        "ูุง ุชุญุงูู ุฅุฑุถุงุก ุงูุทุงูุจ ุจุงูุฅุฌุงุจุฉ ุนูู ููุงุถูุน ุบูุฑ ุชุนููููุฉุ ุญุชู ูู ุฃุตุฑู ุฃู ุญุงูู ุชุบููููุง ุจุณูุงู ููููุงุฆู ูุฒูู. "
        "ูู ุญุงุฒููุง ููุจููุง ูู ุงูููุช ููุณู.\n\n"
        "ูุฏูู ูู ุฃู ุชููู ูุนููู ููููุงุก ููุซููุ ุชุดุฑุญ ุงูููุงููู ุจูุถูุญุ ูุชูุฌูู ุงูุทุงูุจ ูุญู ุงูููู ุงูุนููู ุงูุตุญูุญ ููุท."
    )
}

@app.route("/ask", methods=["POST"])
def ask():
    # ๐ ุงุณุชูุจุงู ููู ุงูุตูุช ูู Unity
    if "audio" not in request.files:
        return jsonify({"error": "ููู ุงูุตูุช ุบูุฑ ููุฌูุฏ"}), 400

    audio_file = request.files["audio"]

    # ๐ ุญูุธ ุงูุตูุช ูุคูุชูุง
    with tempfile.NamedTemporaryFile(delete=False, suffix=".wav") as temp_audio:
        audio_file.save(temp_audio.name)
        audio_path = temp_audio.name

    # ๐ค 1) ุชุญููู ุงูุตูุช ุฅูู ูุต ุนุจุฑ Whisper
    try:
        transcription = client.audio.transcriptions.create(
            model="gpt-4o-mini-transcribe",   # ูููุฐุฌ ุชุญููู ุงูุตูุช
            file=open(audio_path, "rb")
        )
        user_text = transcription.text.strip()
    except Exception as e:
        return jsonify({"error": f"ูุดู ูู ุงูุชุนุฑู ุนูู ุงูุตูุช: {str(e)}"}), 500

    # ๐ง 2) ุฅุฑุณุงู ุงููุต ุฅูู ChatGPT ูุน ุงููPrompt
    try:
        completion = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                SYSTEM_PROMPT,
                {"role": "user", "content": user_text}
            ]
        )
        ai_answer = completion.choices[0].message.content
    except Exception as e:
        return jsonify({"error": f"ูุดู ูู ุงูุงุชุตุงู ุจู ChatGPT: {str(e)}"}), 500

    # ๐ฆ 3) ุฅุนุงุฏุฉ ุงูุฑุฏ ุฅูู Unity
    return jsonify({
        "recognized_text": user_text,
        "chatgpt_response": ai_answer
    })


if __name__ == "__main__":
    # Render ูุนุทูู ุงููุชุบูุฑ PORT ุชููุงุฆููุง
    port = int(os.environ.get("PORT", 5000))
    # 0.0.0.0 ุนุดุงู ูููู ูุชุงุญ ููุฅูุชุฑูุช
    app.run(host="0.0.0.0", port=port)